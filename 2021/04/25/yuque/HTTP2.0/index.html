<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="本文字数：3825 字 预计阅读时间：20 分钟 导读 http2.0 是一种安全高效的下一代 http 传输协议。安全是因为 http2.0 建立在 https 协议的基础上，高效是因为它是通过二进制分帧来进行数据传输。正因为这些特性，http2.0 协议也在被越来越多的网站支持。据统计，截止至 2018 年 8 月，已经有 27.9%的网站支持 http2.0。 本文将从概述、原理、实战及">
<meta property="og:type" content="article">
<meta property="og:title" content="HTTP2.0">
<meta property="og:url" content="http://example.com/2021/04/25/yuque/HTTP2.0/index.html">
<meta property="og:site_name" content="Adam">
<meta property="og:description" content="本文字数：3825 字 预计阅读时间：20 分钟 导读 http2.0 是一种安全高效的下一代 http 传输协议。安全是因为 http2.0 建立在 https 协议的基础上，高效是因为它是通过二进制分帧来进行数据传输。正因为这些特性，http2.0 协议也在被越来越多的网站支持。据统计，截止至 2018 年 8 月，已经有 27.9%的网站支持 http2.0。 本文将从概述、原理、实战及">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/jpeg/21377586/1619340543736-a33f0c98-6dbb-4088-95a8-8d42c25df28e.jpeg#clientId=u148c49a8-157a-4&from=drop&id=u449ec38d&margin=%5Bobject%20Object%5D&name=1.jpg&originHeight=145&originWidth=798&originalType=binary&size=16049&status=done&style=none&taskId=uf8ec65be-f7fd-44db-af5d-1208b45fafb">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/gif/21377586/1619340548956-54a67302-7ca7-4ed6-b03e-22497facf880.gif#clientId=u148c49a8-157a-4&from=drop&id=u1cfa2027&margin=%5Bobject%20Object%5D&name=2.gif&originHeight=281&originWidth=1200&originalType=binary&size=2075450&status=done&style=none&taskId=u963af8b6-9efa-4aab-9114-635366bd545">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/jpeg/21377586/1619340552914-6d85f416-ef90-425c-aadf-5b8012ea6a0e.jpeg#clientId=u148c49a8-157a-4&from=drop&height=328&id=ud9ea1c6a&margin=%5Bobject%20Object%5D&name=3.jpg&originHeight=328&originWidth=624&originalType=binary&size=27637&status=done&style=none&taskId=u5db12245-ba46-48b9-9407-0903347de64&width=624">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/5.jpg#id=tSPAW&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/6.jpg#id=F2mKG&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/7.png#id=k57oQ&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/8.png#id=JO7UY&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/9.png#id=nq66g&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/10.png#id=CeWmD&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/11.png#id=GIrmw&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/12.jpg#id=VFj3G&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/13.jpg#id=SMiUA&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/14.jpg#id=FhnAB&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/15.png#id=oWcYU&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/16.png#id=KneJj&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/17.jpg#id=kCDUw&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/18.jpg#id=vtapY&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/19.jpg#id=aFn5I&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/20.jpg#id=lQqww&originalType=binary&status=done&style=none">
<meta property="og:image" content="http://example.com/2021/04/25/yuque/HTTP2.0/21.gif#id=e7aD0&originalType=binary&status=done&style=none">
<meta property="article:published_time" content="2021-04-25T08:48:35.000Z">
<meta property="article:modified_time" content="2021-04-25T08:49:30.295Z">
<meta property="article:author" content="Adam Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2021/jpeg/21377586/1619340543736-a33f0c98-6dbb-4088-95a8-8d42c25df28e.jpeg#clientId=u148c49a8-157a-4&from=drop&id=u449ec38d&margin=%5Bobject%20Object%5D&name=1.jpg&originHeight=145&originWidth=798&originalType=binary&size=16049&status=done&style=none&taskId=uf8ec65be-f7fd-44db-af5d-1208b45fafb">

<link rel="canonical" href="http://example.com/2021/04/25/yuque/HTTP2.0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>HTTP2.0 | Adam</title>
  <meta name="referrer" content="no-referrer" />
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Adam</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/25/yuque/HTTP2.0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Adam Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Adam">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HTTP2.0
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-04-25 16:48:35 / 修改时间：16:49:30" itemprop="dateCreated datePublished" datetime="2021-04-25T16:48:35+08:00">2021-04-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/21377586/1619340543736-a33f0c98-6dbb-4088-95a8-8d42c25df28e.jpeg#clientId=u148c49a8-157a-4&from=drop&id=u449ec38d&margin=%5Bobject%20Object%5D&name=1.jpg&originHeight=145&originWidth=798&originalType=binary&size=16049&status=done&style=none&taskId=uf8ec65be-f7fd-44db-af5d-1208b45fafb" alt="1.jpg"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/gif/21377586/1619340548956-54a67302-7ca7-4ed6-b03e-22497facf880.gif#clientId=u148c49a8-157a-4&from=drop&id=u1cfa2027&margin=%5Bobject%20Object%5D&name=2.gif&originHeight=281&originWidth=1200&originalType=binary&size=2075450&status=done&style=none&taskId=u963af8b6-9efa-4aab-9114-635366bd545" alt="2.gif"></p>
<p>本文字数：<strong>3825 字</strong></p>
<p>预计阅读时间：<strong>20 分钟</strong></p>
<p><strong>导读</strong></p>
<p>http2.0 是一种安全高效的下一代 http 传输协议。安全是因为 http2.0 建立在 https 协议的基础上，高效是因为它是通过二进制分帧来进行数据传输。正因为这些特性，http2.0 协议也在被越来越多的网站支持。据统计，截止至 2018 年 8 月，已经有 27.9%的网站支持 http2.0。</p>
<p>本文将从<strong>概述、原理、实战及检测</strong>等方面来详细介绍 http2.0，希望能够加深你的理解。</p>
<p><strong>什么是 http2.0 协议？</strong></p>
<p>在 http2.0 官网 ① 的描述是：</p>
<p>http/2 is a replacement for how http is expressed “on the wire.” It is not a ground-up rewrite of the protocol; http methods, status codes and semantics are the same, and it should be possible to use the same APIs as http/1.x (possibly with some small additions) to represent the protocol.</p>
<p>The focus of the protocol is on performance; specifically, end-user perceived latency, network and server resource usage. One major goal is to allow the use of a single connection from browsers to a Web site.</p>
<p>The basis of the work was SPDY, but http/2 has evolved to take the community’s input into account, incorporating several improvements in the process.</p>
<p>中文总结一下就是：</p>
<p><strong>● 对 1.x 协议语意的完全兼容</strong></p>
<p>2.0 协议是在 1.x 基础上的升级而不是重写，1.x 协议的方法，状态及 api 在 2.0 协议里是一样的。</p>
<p><strong>● 性能的大幅提升</strong></p>
<p>2.0 协议重点是对终端用户的感知延迟、网络及服务器资源的使用等性能的优化。</p>
<p><strong>http2.0 优化内容</strong></p>
<p><strong>01</strong></p>
<p><strong>二进制分帧（Binary Format）- http2.0 的基石</strong></p>
<p>http2.0 之所以能够突破 http1.X 标准的性能限制，改进传输性能，实现低延迟和高吞吐量，就是因为其新增了二进制分帧层。</p>
<p>帧(frame)包含部分：类型 Type, 长度 Length, 标记 Flags, 流标识 Stream 和 frame payload 有效载荷。</p>
<p>消息(message)：一个完整的请求或者响应，比如请求、响应等，由一个或多个 Frame 组成。</p>
<p>流是连接中的一个虚拟信道，可以承载双向消息传输。每个流有唯一整数标识符。为了防止两端流 ID 冲突，客户端发起的流具有奇数 ID，服务器端发起的流具有偶数 ID。</p>
<p>流标识是描述二进制 frame 的格式，使得每个 frame 能够基于 http2 发送，与流标识联系的是一个流，每个流是一个逻辑联系，一个独立的双向的 frame 存在于客户端和服务器端之间的 http2 连接中。一个 http2 连接上可包含多个并发打开的流，这个并发流的数量能够由客户端设置。</p>
<p>在二进制分帧层上，http2.0 会将所有传输信息分割为更小的消息和帧，并对它们采用二进制格式的编码将其封装，新增的二进制分帧层同时也能够保证 http 的各种动词，方法，首部都不受影响，兼容上一代 http 标准。其中，http1.X 中的首部信息 header 封装到 Headers 帧中，而 request body 将被封装到 Data 帧中。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/21377586/1619340552914-6d85f416-ef90-425c-aadf-5b8012ea6a0e.jpeg#clientId=u148c49a8-157a-4&from=drop&height=328&id=ud9ea1c6a&margin=%5Bobject%20Object%5D&name=3.jpg&originHeight=328&originWidth=624&originalType=binary&size=27637&status=done&style=none&taskId=u5db12245-ba46-48b9-9407-0903347de64&width=624" alt="3.jpg"></p>
<p><strong>02</strong></p>
<p><strong>多路复用 (Multiplexing) / 连接共享</strong></p>
<p>在 http1.1 中，浏览器客户端在同一时间，针对同一域名下的请求有一定数量的限制，超过限制数目的请求会被阻塞。这也是为何一些站点会有多个静态资源 CDN 域名的原因之一。</p>
<p>而 http2.0 中的多路复用优化了这一性能。多路复用允许同时通过单一的 http/2 连接发起多重的请求-响应消息。有了新的分帧机制后，http/2 不再依赖多个 TCP 连接去实现多流并行了。每个数据流都拆分成很多互不依赖的帧，而这些帧可以交错（乱序发送），还可以分优先级，最后再在另一端把它们重新组合起来。</p>
<p>http 2.0 连接都是持久化的，而且客户端与服务器之间也只需要一个连接（每个域名一个连接）即可。http2 连接可以承载数十或数百个流的复用，多路复用意味着来自很多流的数据包能够混合在一起通过同样连接传输。当到达终点时，再根据不同帧首部的流标识符重新连接将不同的数据流进行组装。</p>
<p>上图展示了一个连接上的多个传输数据流：客户端向服务端传输数据帧 stream5，同时服务端向客户端乱序发送 stream1 和 stream3。这次连接上有三个响应请求乱序并行交换。</p>
<p><img src="5.jpg#id=tSPAW&originalType=binary&status=done&style=none"></p>
<p>上图就是 http1.X 和 http2.0 在传输数据时的区别。以货物运输为例再现 http1.1 与 http2.0 的场景：</p>
<p>http1.1 过程：货轮 1 从 A 地到 B 地去取货物，取到货物后，从 B 地返回，然后货轮 2 在 A 返回并卸下货物后才开始再从 A 地出发取货返回，如此有序往返。</p>
<p>http2.0 过程：货轮 1、2、3、4、5 从 A 地无序全部出发，取货后返回，然后根据货轮号牌卸载对应货物。</p>
<p>显然，第二种方式运输货物多，河道的利用率高。</p>
<p>03</p>
<p><strong>头部压缩（Header Compression）</strong></p>
<p>http1.x 的头带有大量信息，而且每次都要重复发送。http/2 使用 encoder 来减少需要传输的 header 大小，通讯双方各自缓存一份头部字段表，既避免了重复 header 的传输，又减小了需要传输的大小。</p>
<p>对于相同的数据，不再通过每次请求和响应发送，通信期间几乎不会改变通用键-值对(用户代理、可接受的媒体类型，等等)只需发送一次。</p>
<p>事实上,如果请求中不包含首部(例如对同一资源的轮询请求)，那么，首部开销就是零字节，此时所有首部都自动使用之前请求发送的首部。</p>
<p>如果首部发生了变化，则只需将变化的部分加入到 header 帧中，改变的部分会加入到头部字段表中，首部表在 http 2.0 的连接存续期内始终存在，由客户端和服务器共同渐进地更新。</p>
<p>需要注意的是，http 2.0 关注的是首部压缩，而我们常用的 gzip 等是报文内容（body）的压缩，二者不仅不冲突，且能够一起达到更好的压缩效果。</p>
<p>http/2 使用的是专门为首部压缩而设计的 HPACK② 算法。</p>
<p><img src="6.jpg#id=F2mKG&originalType=binary&status=done&style=none"></p>
<p>从上图可以看到 http1.X 不支持首部压缩，而 http2.0 的压缩算法效果最好，发送和接受的数据量都是最少的。</p>
<p><strong>04</strong></p>
<p><strong>压缩原理</strong></p>
<p>用 header 字段表里的索引代替实际的 header。</p>
<p>http/2 的 HPACK 算法使用一份索引表来定义常用的 http Header，把常用的 http Header 存放在表里，请求的时候便只需要发送在表里的索引位置即可。</p>
<p>例如 :method=GET 使用索引值 2 表示，:path=/index.html 使用索引值 5 表示，如下图：</p>
<p><img src="7.png#id=k57oQ&originalType=binary&status=done&style=none"></p>
<p>完整的列表参考：HPACK Static Table③ 。</p>
<p>只要给服务端发送一个 Frame，该 Frame 的 Payload 部分存储 0x8285，Frame 的 Type 设置为 Header 类型，便可表示这个 Frame 属于 http Header，请求的内容是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1GET &#x2F;index.html</span><br></pre></td></tr></table></figure>

<p>为什么是 0x8285，而不是 0x0205？这是因为高位设置为 1 表示这个字节是一个完全索引值（key 和 value 都在索引中）。</p>
<p>类似的，通过高位的标志位可以区分出这个字节是属于一个完全索引值，还是仅索引了 key，还是 key 和 value 都没有索引(参见：HTTP/2 首部压缩的 OkHttp3 实现 ④)。</p>
<p>因为索引表的大小的是有限的，它仅保存了一些常用的 http Header，同时每次请求还可以在表的末尾动态追加新的 http Header 缓存，动态部分称之为 Dynamic Table。Static Table 和 Dynamic Table 在一起组合成了索引表：</p>
<p><img src="8.png#id=JO7UY&originalType=binary&status=done&style=none"></p>
<p>HPACK 不仅仅通过索引键值对来降低数据量，同时还会将字符串进行霍夫曼编码来压缩字符串大小。</p>
<p>以常用的 User-Agent 为例，它在静态表中的索引值是 58，它的值是不存在表中的，因为它的值是多变的。第一次请求的时候它的 key 用 58 表示，表示这是一个 User-Agent ，它的值部分会进行霍夫曼编码（如果编码后的字符串变更长了，则不采用霍夫曼编码）。</p>
<p>服务端收到请求后，会将这个 User-Agent 添加到 Dynamic Table 缓存起来，分配一个新的索引值。客户端下一次请求时，假设上次请求 User-Agent 的在表中的索引位置是 62， 此时只需要发送 0xBE（同样的，高位置 1），便可以代表：User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.146 Safari/537.36。</p>
<p>其过程如下图所示：</p>
<p><img src="9.png#id=nq66g&originalType=binary&status=done&style=none"></p>
<p>最终，相同的 Header 只需要发送索引值，新的 Header 会重新加入 Dynamic Table。</p>
<p><strong>05</strong></p>
<p><strong>请求优先级（Request Priorities）</strong></p>
<p>把 http 消息分为很多独立帧之后，就可以通过优化这些帧的交错和传输顺序进一步优化性能。每个流都可以带有一个 31 比特的优先值：0 表示最高优先级；2 的 31 次方-1 表示最低优先级。</p>
<p>服务器可以根据流的优先级，控制资源分配（CPU、内存、带宽），而在响应数据准备好之后，优先将最高优先级的帧发送给客户端。高优先级的流都应该优先发送，但又不会绝对的。绝对地准守，可能又会引入首队阻塞的问题：高优先级的请求慢导致阻塞其他资源交付。</p>
<p>分配处理资源和客户端与服务器间的带宽，不同优先级的混合也是必须的。客户端会指定哪个流是最重要的，有一些依赖参数，这样一个流可以依赖另外一个流。优先级别可以在运行时动态改变，当用户滚动页面时，可以告诉浏览器哪个图像是最重要的，你也可以在一组流中进行优先筛选，能够突然抓住重点流。</p>
<p>● 优先级最高：主要的 html</p>
<p>● 优先级高：CSS 文件</p>
<p>● 优先级中：js 文件</p>
<p>● 优先级低：图片</p>
<p><strong>06</strong></p>
<p><strong>服务端推送（Server Push）</strong></p>
<p>服务器可以对一个客户端请求发送多个响应，服务器向客户端推送资源无需客户端明确地请求。并且，服务端推送能把客户端所需要的资源伴随着 index.html 一起发送到客户端，省去了客户端重复请求的步骤。</p>
<p>正因为没有发起请求，建立连接等操作，所以静态资源通过服务端推送的方式可以极大地提升速度。Server Push 让 http1.x 时代使用内嵌资源的优化手段变得没有意义；如果一个请求是由你的主页发起的，服务器很可能会响应主页内容、logo 以及样式表，因为它知道客户端会用到这些东西，这相当于在一个 HTML 文档内集合了所有的资源。</p>
<p>不过与之相比，服务器推送还有一个很大的优势：可以缓存！也让在遵循同源的情况下，不同页面之间可以共享缓存资源成为可能。</p>
<p><img src="10.png#id=CeWmD&originalType=binary&status=done&style=none"></p>
<p>注意两点：</p>
<p>1、推送遵循同源策略；</p>
<p>2、这种服务端的推送是基于客户端的请求响应来确定的。</p>
<p>当服务端需要主动推送某个资源时，便会发送一个 Frame Type 为 PUSH_PROMISE 的 Frame，里面带了 PUSH 需要新建的 Stream ID。意思是告诉客户端：接下来我要用这个 ID 向你发送东西，客户端准备好接着。客户端解析 Frame 时，发现它是一个 PUSH_PROMISE 类型，便会准备接收服务端要推送的流。</p>
<p><strong>http2.0 性能瓶颈</strong></p>
<p>启用 http2.0 后会给性能带来很大的提升，但同时也会带来新的性能瓶颈。因为现在所有的压力集中在底层一个 TCP 连接之上，TCP 很可能就是下一个性能瓶颈，比如 TCP 分组的队首阻塞问题，单个 TCP packet 丢失导致整个连接阻塞，无法逃避，此时所有消息都会受到影响。未来，服务器端针对 http 2.0 下的 TCP 配置优化至关重要。</p>
<p><strong>01</strong></p>
<p><strong>如何升级 http2.0 协议</strong></p>
<p>nginx 服务器升级 http2.0 协议需要满足如下条件：</p>
<p>1、nginx 版本高于 1.9.5；</p>
<p>2、–with-http_ssl_module 跟 –with-http_v2_module</p>
<p>–with-http_ssl_module 模块是因为 http2.0 协议是一种 https 协议。</p>
<p><strong>02</strong></p>
<p><strong>查看你的 nginx 配置</strong></p>
<p><code>nginx -V</code></p>
<p><img src="11.png#id=GIrmw&originalType=binary&status=done&style=none"></p>
<p>这个是已经添加了对应模块。没有这两个模块的需要手动编译安装。</p>
<p><strong>03</strong></p>
<p><strong>找到 nginx 文件目录</strong></p>
<p><img src="12.jpg#id=VFj3G&originalType=binary&status=done&style=none"></p>
<p><strong>04</strong></p>
<p><strong>编译安装 nginx 文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx  --with-http_stub_status_module  --with-http_ssl_module  --with-http_v2_module</span><br></pre></td></tr></table></figure>

<p><img src="13.jpg#id=SMiUA&originalType=binary&status=done&style=none"></p>
<p>然后执行如下命令，进行编译安装。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1make2make install</span><br></pre></td></tr></table></figure>

<p><img src="14.jpg#id=FhnAB&originalType=binary&status=done&style=none"></p>
<p><img src="15.png#id=oWcYU&originalType=binary&status=done&style=none"></p>
<p><strong>05</strong></p>
<p><strong>更改 nginx 配置</strong></p>
<p>安装结束后将 nginx.config 文件中 443 端口添加 http2；</p>
<p><img src="16.png#id=KneJj&originalType=binary&status=done&style=none"></p>
<p><strong>06</strong></p>
<p><strong>启动 nginx</strong></p>
<p>最后一步，重启 nginx nginx restart（注意不要直接   nginx -s reload ）。这时候你的站点就升级为了 http2.0 协议了。</p>
<p><strong>检测</strong></p>
<p>升级完成后，怎么确定自己的站点是 http2.0 协议呢？一般有如下几种方法：</p>
<p><strong>●chrome devtool</strong></p>
<p>打开 chrome 调试工具，在 network 勾选 protocol 项，h2 代表的是 http2.0 协议，可以看到笔者的网站已经都升级好了；</p>
<p><strong>● 网站</strong></p>
<p>SSL lab⑤ 一个 SSL 服务器检测的网站，对网站进行安全评级，并将检测结果自动生成一个详细的评价报告；</p>
<p><strong>● 插件</strong></p>
<p>http/2 and SPDY indicator 这是一款检测 http2.0 和 SPDY 协议（Google 开发的基于 TCP 的会话层协议）的插件。</p>
<p>参考资料：</p>
<p>[1].<a target="_blank" rel="noopener" href="https://http2.github.io/">https://http2.github.io/</a></p>
<p>[2].<a target="_blank" rel="noopener" href="http://http2.github.io/http2-spec/compression.html">http://http2.github.io/http2-spec/compression.html</a></p>
<p>[3].<a target="_blank" rel="noopener" href="http://http2.github.io/http2-spec/compression.html#rfc.section.A">http://http2.github.io/http2-spec/compression.html#rfc.section.A</a></p>
<p>[4].<a target="_blank" rel="noopener" href="https://neyoufan.github.io/2017/01/06/android/OkHttp3%E4%B8%AD%E7%9A%84HTTP2%E9%A6%96%E9%83%A8%E5%8E%8B%E7%BC%A9/">https://neyoufan.github.io/2017/01/06/android/OkHttp3中的HTTP2首部压缩/</a></p>
<p>[5].<a target="_blank" rel="noopener" href="https://www.ssllabs.com/ssltest/analyze.html">https://www.ssllabs.com/ssltest/analyze.html</a></p>
<p><strong>也许你还想看</strong></p>
<p><strong>（▼ 点击文章标题或封面查看）</strong></p>
<p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzU3NTY3MTQzMg==%E2%88%A3=2247483791&idx=1&sn=f6fd2d66e35e93a27e5918b4ee4c5358&chksm=fd1edc68ca69557ef2d79b7b6bf4ea89de6affa6919c1c85e70d888464e007f9b8683f4e949a&scene=21#wechat_redirect">搜狐新闻推荐算法  |  呈现给你的，都是你所关心的</a></p>
<p>2018-08-30</p>
<p><img src="17.jpg#id=kCDUw&originalType=binary&status=done&style=none"></p>
<p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzU3NTY3MTQzMg==%E2%88%A3=2247484862&idx=1&sn=9e1723862ce80488dabc4d3535464cae&chksm=fd1ed859ca69514f02c055a5c8d636f8af2eddd6e7deb0d496d36bb1e5fd404aef90e435b50c&scene=21#wechat_redirect">新闻推荐系统的 CTR 预估模型</a></p>
<p>2019-04-18</p>
<p><img src="18.jpg#id=vtapY&originalType=binary&status=done&style=none"></p>
<p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzU3NTY3MTQzMg==%E2%88%A3=2247483690&idx=1&sn=7187cad324ad14821bf88fa8be4eebf0&chksm=fd1edccdca6955db28c8ce1f24c92367f06cbf81793b2125fa0d76c4692d4a7096f013ca695f&scene=21#wechat_redirect">互联网架构演进之路</a></p>
<p>2018-08-16</p>
<p><img src="19.jpg#id=aFn5I&originalType=binary&status=done&style=none"></p>
<p>加入<strong>搜狐技术作者天团</strong></p>
<p><strong>千元稿费等你来！</strong></p>
<p>戳这里！☛</p>
<p><img src="20.jpg#id=lQqww&originalType=binary&status=done&style=none"></p>
<p><img src="21.gif#id=e7aD0&originalType=binary&status=done&style=none"></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/04/25/yuque/HTTPS/" rel="prev" title="HTTPS">
      <i class="fa fa-chevron-left"></i> HTTPS
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/04/25/hello-world/" rel="next" title="Hello World">
      Hello World <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Adam Blog</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Adam Blog</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
